# Part 3 ‚Äî Making our applications more robust with schema generated types

## üß† Learning objectives

- Using types in vanilla JavaScript with JSDoc and TypeScript.
- How static type checking in vanilla JavaScript helps reduce bugs.
- TypeScript options for generating types from schemas.

## Copy over your work so far

```sh
cp 02-creating-flexible-validation-rules/routes.js 03-generated-schema-types/routes.js
cp -r 02-creating-flexible-validation-rules/schemas/ 03-generated-schema-types/
```

## Start your server

```sh
npm start --part=03-generated-schema-types
```

## Using types in vanilla JavaScript with JSDoc and TypeScript

You can combine generated types and JSDoc annotations to get type hinting and
static type checking in JavaScript.

The [json-schema-to-typescript](https://npm.im/json-schema-to-typescript) package
can take your JSON schemas and generate TypeScript type definitions for ypu.
It provides a library and a CLI. The CLI is pretty flexible, for example you can
point it at a directory full of schemas and it will generate the corresponding
type definitions files for all of them:

```bash
npx json2ts -i schemas/ -o types/
```

The following packages have been pre-installed as `devDepenencies`:

- [json-schema-to-typescript](TODO)
- [typescript](TODO)
- [@types/node](TODO) ‚Äî Node.js types.

<!-- TOOD: Rework this -->
Define some npm run scripts in [package.json](package.json):

```json
{
  "scripts": {
    "schema-types:generate": "json2ts -i schemas/ -o types/",
    "schema-types:clean": "rm -rf types",
    "build:schema-types": "npm run schema-types:clean && npm run schema-types:generate"
  }
}
```

The script `build:schema-types` removes any existing generated types. It then
runs the `json-schema-to-typescript` CLI to generate a type definition file
from the recipe JSON schema.

When you run the script:

```bash
npm run build:schema-types
```

You'll see a file named [recipe.schema.d.ts](types/recipe.schema.d.ts) has been generated in the `types`
directory. This contains a `RecipeSchema` TypeScript interface which has been
inferred from the recipe JSON schema:


<!-- TODO: Update this -->
```typescript
/* tslint:disable */
/**
 * This file was automatically generated by json-schema-to-typescript.
 * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,
 * and run json-schema-to-typescript to regenerate this file.
 */

export interface IceCreamSchema {
  flavour: string;
  price: number;
  stock: number;
  [k: string]: unknown;
}
```

Create a **"tsconfig.json"** file which configures the TypeScript compiler to
check your JavaScript code:

```json
{
  "compilerOptions": {
    "lib": ["es2020", "DOM"],
    "moduleResolution": "node",
    "module": "esnext",
    "allowJs": true,
    "checkJs": true,
    "noEmit": true,
    "strict": true
  },
  "include": ["*.js"],
  "exclude": ["node_modules"]
}
```

Add a couple more npm run scripts to [package.json](package.json):

```json
{
  "scripts": {
    "check-types": "tsc",
    "build": "npm run build:schema-types && npm run check-types"
  }
}
```

<!-- TOOD: Move this into the exercise -->

<!-- TODO: Rework -->
Now let's create a file named **"example.js"** which uses this generated type:

```javascript
/** @type import('./types/ice-cream.schema').IceCreamSchema */
 const iceCreamData = {
  flavour: "Pistacho",
  price: 1.99,
  stock: null
};
```

And then you can run:

```bash
npm run check-types
```

This will run the TypeScript compiler against you JavaScript code. It will
statically check the types in our JavaScript code, and alert you to the type
error in your code:

```
example.js:7:2 - error TS2322: Type 'null' is not assignable to type 'number'.

7  stock: null,
   ~~~~~

  types/ice-cream.schema.d.ts:11:3
    11   stock: number;
         ~~~~~
    The expected type comes from property 'stock' which is declared here on type 'IceCreamSchema'


Found 1 error.
```

For convenience, you can run `npm run build` to automatically generate the types
and type check our JavaScript all in one go.

You now have automatic types from our JSON schemas, allowing us to type check our JavaScript code.

## üéØ TODO: Exercise 3.1

**Integrate a generated schema type and eliminate the bug.**

- TODO

Check your work by running:

```sh
npm test 03-generated-schema-types/test/routes.exercise-3.1.test.js
```

<details>
  <summary><strong>Exercise hints (try without them to start with)</strong></summary>

  - TODO
</details>

<details>
  <summary><strong>Solution</strong></summary>

  You can see a passing solution in
  [completed/routes.exercise-3.1.completed.js](completed/routes.exercise-3.1.completed.js).
</details>

## TypeScript options for generating types from schemas

<!-- TODO: Update code blocks -->

If you're writing your JSON schemas "by hand", you can use the [json-schema-to-ts](https://npm.im/json-schema-to-ts) library to infer TypeScript types from them.

First define your schema:

```typescript
const iceCreamSchema = {
  type: "object",
  properties: {
    flavour: { type: "string" },
    price: { type: "number" },
    stock: { type: "number" },
  },
  required: ["flavour", "price", "stock"],
} as const;
```

Then use `json-schema-to-ts` to infer a type from it:

```typescript
import { FromSchema } from "json-schema-to-ts";

type IceCream = FromSchema<typeof iceCreamSchema>;

const iceCreamData: IceCream = {
  flavour: "Pistacho",
  price: 1.99,
  stock: null,
};
```

The inferred type you get from the code above is equivalent to this type definition:

```typescript
type IceCream = {
  flavour: string;
  price: number;
  stock: number;
};
```

<!-- TODO: Reword -->
As the `stock` property is `null` in the `iceCreamData` object, the TypeScript compiler will raise an error: `Type 'null' is not assignable to type 'number'`.

If you prefer to have schema generation and type inference all in one, you can use the [TypeBox](https://npm.im/@sinclair/typebox) library. First you define your schema using TypeBox's `Type` methods:

```typescript
import { Static, Type } from "@sinclair/typebox";

const iceCreamSchema = Type.Object({
  flavour: Type.String(),
  price: Type.Number(),
  stock: Type.Number(),
});
```

Then you can infer a type from the schema:

```typescript
type IceCream = Static<typeof iceCreamSchema>;

const iceCreamData: IceCream = {
  flavour: "Pistacho",
  price: 1.99,
  stock: null,
};
```

This gives you the same type and static type checking behaviour that `json-schema-to-ts` provides, but with the added bonus of schema generation.

## ‚è≠Ô∏è Next part

[Part 4 ‚Äî Sending back validation errors in an effective response format](../04-validation-error-responses/README.md)
